# Code Review Guidelines - Universal Detailer\n\n> **Comprehensive code review checklist for Claude Code implementation**\n\n## üìã Review Status\n\n**Current Status**: üîÑ **AWAITING CLAUDE CODE IMPLEMENTATION**  \n**Last Review**: July 12, 2025  \n**Reviewer**: Claude (Anthropic)  \n\n## üéØ Review Objectives\n\n### Primary Goals\n1. **Functionality**: Ensure core features work as specified\n2. **Safety**: Verify error handling and memory management\n3. **Performance**: Check efficiency and resource usage\n4. **Compatibility**: Validate ComfyUI integration\n5. **Maintainability**: Assess code quality and documentation\n\n## üîç Current Code Status Review\n\n### ‚úÖ Skeleton Code Assessment (Pre-Implementation)\n\n#### Strengths\n- **Complete Interface**: All INPUT_TYPES and RETURN_TYPES properly defined\n- **Proper Structure**: Modular design with separate detection/masking/utils modules\n- **ComfyUI Compliance**: Follows ComfyUI node conventions\n- **Error Handling Framework**: Basic try-catch structure in place\n- **Documentation**: Comprehensive docstrings and TODO markers\n\n#### Architecture Review\n```python\n# ‚úÖ GOOD: Proper ComfyUI node structure\nclass UniversalDetailerNode:\n    RETURN_TYPES = (\"IMAGE\", \"MASK\", \"MASK\", \"MASK\", \"STRING\")\n    RETURN_NAMES = (\"image\", \"detection_masks\", \"face_masks\", \"hand_masks\", \"detection_info\")\n    FUNCTION = \"process\"\n    CATEGORY = \"image/postprocessing\"\n```\n\n#### Input Validation\n```python\n# ‚úÖ GOOD: Comprehensive parameter definitions\n\"confidence_threshold\": (\n    \"FLOAT\", \n    {\"default\": 0.5, \"min\": 0.1, \"max\": 0.95, \"step\": 0.05}\n)\n```\n\n## üö® Critical Implementation Checkpoints\n\n### 1. YOLO Detection Implementation\n**Priority: üî• HIGHEST**\n\n```python\n# ‚ö†Ô∏è MUST IMPLEMENT\ndef _load_detection_model(self, model_name: str):\n    # Check for:\n    # - Proper ultralytics YOLO integration\n    # - Model caching mechanism\n    # - Error handling for missing models\n    # - Device selection (CPU/GPU)\n```\n\n**Review Criteria:**\n- [ ] Uses `ultralytics.YOLO` correctly\n- [ ] Implements model caching to avoid reloading\n- [ ] Handles model file not found gracefully\n- [ ] Supports GPU/CPU device selection\n- [ ] Memory cleanup after model loading\n\n### 2. Detection Logic\n**Priority: üî• HIGHEST**\n\n```python\n# ‚ö†Ô∏è MUST IMPLEMENT\ndef _detect_parts(self, image, model, target_parts, confidence_threshold):\n    # Check for:\n    # - Proper image preprocessing for YOLO\n    # - Confidence threshold filtering\n    # - Multi-part detection support\n    # - Result standardization\n```\n\n**Review Criteria:**\n- [ ] Image preprocessing matches YOLO requirements\n- [ ] Confidence filtering implemented correctly\n- [ ] Returns standardized detection format\n- [ ] Handles empty detection results\n- [ ] Performance optimization for batch processing\n\n### 3. Mask Generation\n**Priority: üî• HIGHEST**\n\n```python\n# ‚ö†Ô∏è MUST IMPLEMENT\ndef _generate_masks(self, detections, image_shape, mask_padding, mask_blur):\n    # Check for:\n    # - Bounding box to mask conversion\n    # - Padding and blur application\n    # - Mask separation by type\n    # - Proper tensor format\n```\n\n**Review Criteria:**\n- [ ] Correct bounding box to mask conversion\n- [ ] Padding implemented using morphological operations\n- [ ] Gaussian blur applied properly\n- [ ] Separates face/hand masks correctly\n- [ ] Returns correct tensor format for ComfyUI\n\n### 4. ComfyUI Inpainting Integration\n**Priority: üî• HIGHEST**\n\n```python\n# ‚ö†Ô∏è MUST IMPLEMENT\ndef _inpaint_regions(self, image, masks, model, vae, positive, negative, **kwargs):\n    # Check for:\n    # - ComfyUI sampling pipeline integration\n    # - VAE encode/decode process\n    # - Proper conditioning usage\n    # - Result blending\n```\n\n**Review Criteria:**\n- [ ] Uses ComfyUI's sampling functions correctly\n- [ ] VAE encoding/decoding implemented\n- [ ] Conditioning applied properly\n- [ ] Inpainted results blended naturally\n- [ ] Memory management during inpainting\n\n## üõ°Ô∏è Safety & Error Handling Review\n\n### Memory Management\n```python\n# ‚úÖ CHECK FOR:\n- torch.no_grad() usage where appropriate\n- Proper tensor device management\n- Memory cleanup after processing\n- VRAM usage optimization\n```\n\n### Error Handling\n```python\n# ‚úÖ CHECK FOR:\n- Graceful degradation on model loading failure\n- Handling of empty detection results\n- CUDA out of memory error recovery\n- Invalid parameter value handling\n```\n\n### Input Validation\n```python\n# ‚úÖ CHECK FOR:\n- Parameter range validation\n- Image tensor format verification\n- Model compatibility checks\n- Resource availability verification\n```\n\n## ‚ö° Performance Review Criteria\n\n### Efficiency Checks\n- [ ] **Model Caching**: Avoid reloading models unnecessarily\n- [ ] **Batch Processing**: Efficient handling of multiple detections\n- [ ] **Memory Usage**: Reasonable VRAM consumption\n- [ ] **Processing Time**: Meets performance requirements (15s for 1024x1024)\n\n### Optimization Opportunities\n- [ ] **Lazy Loading**: Load models only when needed\n- [ ] **Result Caching**: Cache detection results for identical inputs\n- [ ] **Parallel Processing**: Utilize multiple GPU streams if available\n- [ ] **Memory Pooling**: Reuse tensor memory when possible\n\n## üß™ Testing Requirements\n\n### Unit Test Coverage\n```python\n# Required test cases:\n- Model loading with valid/invalid model names\n- Detection with various confidence thresholds\n- Mask generation with different padding/blur values\n- Inpainting with different strength settings\n- Error handling for edge cases\n```\n\n### Integration Test Scenarios\n- [ ] **Face-only detection**: Test with portrait images\n- [ ] **Hand-only detection**: Test with hand photos\n- [ ] **Multi-part detection**: Test with full-body images\n- [ ] **No detection cases**: Test with images containing no faces/hands\n- [ ] **Memory stress test**: Test with large images and batch processing\n\n## üìä Quality Metrics\n\n### Code Quality Indicators\n- [ ] **Type Hints**: All functions have proper type annotations\n- [ ] **Documentation**: Comprehensive docstrings\n- [ ] **Logging**: Appropriate log levels and messages\n- [ ] **Comments**: Complex logic explained clearly\n- [ ] **Naming**: Clear and consistent variable/function names\n\n### Performance Benchmarks\n- [ ] **Detection Speed**: <3 seconds for 1024x1024 image\n- [ ] **Memory Usage**: <8GB total (including model)\n- [ ] **Accuracy**: Proper detection of faces/hands in test images\n- [ ] **Quality**: Inpainting results visually acceptable\n\n## üöÄ Implementation Progress Tracking\n\n### Phase 1: Core Detection (Expected)\n- [ ] **YOLODetector.load_model()** - Load YOLO models\n- [ ] **YOLODetector.detect()** - Run detection inference\n- [ ] **MaskGenerator.generate_masks()** - Create masks from detections\n- [ ] **Basic error handling** - Handle common failure cases\n\n### Phase 2: Integration (Expected)\n- [ ] **ComfyUI inpainting integration** - Connect to sampling pipeline\n- [ ] **Result composition** - Blend original and inpainted areas\n- [ ] **Parameter validation** - Validate all input parameters\n- [ ] **Memory optimization** - Efficient resource usage\n\n### Phase 3: Polish (Expected)\n- [ ] **Advanced error handling** - Comprehensive error recovery\n- [ ] **Performance optimization** - Speed and memory improvements\n- [ ] **Model auto-download** - Automatic model acquisition\n- [ ] **Final testing** - Comprehensive test coverage\n\n## üîß Common Implementation Issues to Watch For\n\n### Potential Problems\n1. **YOLO Model Loading**\n   - Incorrect model file paths\n   - Missing ultralytics dependency\n   - Device compatibility issues\n\n2. **Image Format Conversion**\n   - Incorrect tensor shape handling\n   - Color space conversion errors\n   - Normalization issues\n\n3. **ComfyUI Integration**\n   - Incorrect sampling function usage\n   - VAE encode/decode errors\n   - Conditioning format mismatches\n\n4. **Memory Management**\n   - GPU memory leaks\n   - Inefficient tensor operations\n   - Large model caching issues\n\n### Best Practices Verification\n- [ ] **Follows ComfyUI conventions** - Node structure and naming\n- [ ] **Implements specifications** - Adheres to SPECIFICATIONS.md\n- [ ] **Maintains compatibility** - Works with existing ComfyUI workflows\n- [ ] **Provides user feedback** - Clear error messages and progress indication\n\n## üìù Review Checklist Template\n\nWhen Claude Code completes implementation, verify:\n\n### ‚úÖ Functionality\n- [ ] All TODO comments replaced with working code\n- [ ] Core detection pipeline functional\n- [ ] Mask generation working correctly\n- [ ] Inpainting integration successful\n- [ ] Results match expected format\n\n### ‚úÖ Safety\n- [ ] Error handling comprehensive\n- [ ] Memory management proper\n- [ ] Input validation implemented\n- [ ] Graceful failure modes\n\n### ‚úÖ Performance\n- [ ] Processing time acceptable\n- [ ] Memory usage reasonable\n- [ ] Model loading efficient\n- [ ] Batch processing optimized\n\n### ‚úÖ Quality\n- [ ] Code well-documented\n- [ ] Follows Python best practices\n- [ ] Type hints present\n- [ ] Logging appropriate\n\n## üéØ Success Criteria\n\n### Minimum Viable Product\n- [x] **Project Structure** - Complete skeleton in place\n- [ ] **Face Detection** - Can detect faces in images\n- [ ] **Mask Generation** - Creates appropriate masks\n- [ ] **Basic Inpainting** - Integrates with ComfyUI pipeline\n- [ ] **Error Handling** - Graceful failure modes\n\n### Full Implementation\n- [ ] **Multi-part Detection** - Faces, hands, and fingers\n- [ ] **Parameter Control** - All settings functional\n- [ ] **Performance Optimization** - Meets speed/memory requirements\n- [ ] **Documentation** - Complete user and developer docs\n- [ ] **Testing** - Comprehensive test coverage\n\n---\n\n## üìû Review Process\n\n**When Claude Code pushes changes:**\n1. Automated checks will run\n2. Manual code review using this checklist\n3. Testing with sample images\n4. Performance benchmarking\n5. Documentation verification\n6. Final approval or feedback\n\n**Review will be documented in GitHub Issues/PRs for tracking.**\n\n---\n\n*This review guide will be updated as implementation progresses.*"